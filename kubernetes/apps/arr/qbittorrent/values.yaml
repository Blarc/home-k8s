app-template:
  controllers:
    qbittorrent:
      annotations:
        reloader.stakater.com/auto: "true"
      initContainers:
        setup-config:
          image:
            repository: docker.io/busybox
            tag: latest
          command:
            - sh
            - -c
            - |
              echo "Copying custom qBittorrent config..."
              mkdir -p /config/qBittorrent
              cp -f /defaults/qBittorrent.conf /config/qBittorrent/qBittorrent.conf
              echo "Config copied successfully"
      containers:
        app:
          image:
            repository: ghcr.io/home-operations/qbittorrent
            tag: 5.1.4@sha256:56ecd30a7f5e1357daf5eea2a6935134d329b7b268a3a9b9c67041b65fb87fc6
          env:
            TZ: Ljubljana/Europe
            QBT_WEBUI_PORT: &port 80
            QBT_TORRENTING_PORT: &torrentPort 50469
          probes:
            liveness: &probes
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /api/v2/app/version
                  port: *port
                initialDelaySeconds: 0
                periodSeconds: 10
                timeoutSeconds: 1
                failureThreshold: 3
            readiness: *probes
            startup:
              enabled: true
              spec:
                failureThreshold: 30
                periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: [ "ALL" ] }
          resources:
            requests:
              cpu: 100m
            limits:
              memory: 8Gi
  defaultPodOptions:
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
  service:
    app:
      forceRename: "{{ .Release.Name }}"
      primary: true
      ports:
        http:
          port: *port
    bittorrent:
      type: LoadBalancer
      annotations:
        lbipam.cilium.io/ips: 192.168.1.227
      externalTrafficPolicy: Local
      ports:
        bittorrent-tcp:
          port: *torrentPort
          protocol: TCP
  route:
    app:
      hostnames:
        - "{{ .Release.Name }}.blarc.my.id"
      parentRefs:
        - name: gateway-internal
          namespace: gateway
      rules:
        - backendRefs:
            - identifier: app
              port: *port
          matches:
            - path:
                type: PathPrefix
                value: /
  configMaps:
    config:
      data:
        .qbt.toml: |-
          [qbittorrent]
          addr = "http://localhost:80"
    default-config:
      data:
        qBittorrent.conf: |
          [AutoRun]
          enabled=false
          program=
          
          [LegalNotice]
          Accepted=true
          
          [BitTorrent]
          Session\AsyncIOThreadsCount=10
          Session\DiskCacheSize=-1
          Session\DiskIOReadMode=DisableOSCache
          Session\DiskIOType=SimplePreadPwrite
          Session\DiskIOWriteMode=EnableOSCache
          Session\DiskQueueSize=4194304
          Session\FilePoolSize=40
          Session\HashingThreadsCount=2
          Session\Port=50413
          Session\ResumeDataStorageType=SQLite
          Session\UseOSCache=true
          Session\DefaultSavePath=/media/
          Session\TempPath=/media/incomplete/
          Session\TempPathEnabled=true
          
          [Preferences]
          Connection\PortRangeMin=6881
          Connection\UPnP=false
          General\Locale=en
          General\UseRandomPort=false
          WebUI\Address=*
          WebUI\AuthSubnetWhitelist=10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16
          WebUI\AuthSubnetWhitelistEnabled=true
          WebUI\CSRFProtection=false
          WebUI\HostHeaderValidation=false
          WebUI\LocalHostAuth=false
          WebUI\Port=8080
          WebUI\ServerDomains=*
          WebUI\UseUPnP=false
          Downloads\SavePath=/media/
          Downloads\TempPath=/media/incomplete/
          Downloads\TempPathEnabled=true
  persistence:
    config:
      type: persistentVolumeClaim
      storageClass: topolvm-thin
      accessMode: ReadWriteOnce
      size: 512Mi
    config-file:
      type: configMap
      identifier: config
      globalMounts:
        - path: /config/.qbt.toml
          subPath: .qbt.toml
    default-config:
      type: configMap
      identifier: default-config
      globalMounts:
        - path: /defaults/qBittorrent.conf
          subPath: qBittorrent.conf
    media:
      storageClass: nfs
      size: 250Gi
      accessMode: ReadWriteOnce
      globalMounts:
        - path: /media
    tmp:
      type: emptyDir