openclaw:
  app-template:
    networkpolicies:
      main:
        enabled: true
        rules:
          ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: traefik
              ports:
                - protocol: TCP
                  port: 18789
    configMaps:
      config:
        enabled: true
        data:
          # OpenClaw configuration - JSON5 format
          # Sensitive values use ${ENV_VAR} substitution from environment secret
          # language=json5
          openclaw.json: |
            {
              // Gateway configuration
              "gateway": {
                "port": 18789,
                "mode": "local",
                // IMPORTANT: trustedProxies uses exact IP matching only
                // - CIDR notation is NOT supported - list each proxy IP individually
                // - IPv6 exact addresses may work but are untested
                // - Recommend single-stack IPv4 deployments for simplicity
                "trustedProxies": ["10.0.0.1"]
              },

              // Browser configuration (Chromium sidecar)
              "browser": {
                "enabled": true,
                "defaultProfile": "default",
                "profiles": {
                  "default": {
                    "cdpUrl": "http://localhost:9222",
                    "color": "#4285F4"
                  }
                }
              },
            
              // Models configuration
              "models": {
                "mode": "merge",
                "providers": {
                  "nvidia-nim": {
                    "baseUrl": "https://integrate.api.nvidia.com/v1",
                    "apiKey": "${MOONSHOT_API_KEY}",
                    "api": "openai-completions",
                    "models": [
                      {
                        "id": "moonshotai/kimi-k2.5",
                        "name": "Kimi K2.5 (NVIDIA)",
                        "reasoning": false,
                        "input": [
                          "text"
                        ],
                        "cost": {
                          "input": 0,
                          "output": 0,
                          "cacheRead": 0,
                          "cacheWrite": 0
                        },
                        "contextWindow": 200000,
                        "maxTokens": 8192
                      }
                    ]
                  }
                }
              },
                   
              // Agent configuration
              "agents": {
                "defaults": {
                  "workspace": "/home/node/.openclaw/workspace",
                  "model": {
                    "primary": "kimi"
                  },
                  "models": {
                    "nvidia-nim/moonshotai/kimi-k2.5": {
                      "alias": "kimi"
                    }
                  },
                  "userTimezone": "Europe/Ljubljana",
                  "timeoutSeconds": 600,
                  "maxConcurrent": 1
                },
                "list": [
                  {
                    "id": "main",
                    "default": true,
                    "identity": {
                      "name": "Guppi",
                      "emoji": "ðŸ¤–"
                    }
                  }
                ]
              },

              // Session management
              "session": {
                "scope": "per-sender",
                "store": "/home/node/.openclaw/sessions",
                "reset": {
                  "mode": "idle",
                  "idleMinutes": 60
                }
              },

              // Logging
              "logging": {
                "level": "info",
                "consoleLevel": "info",
                "consoleStyle": "compact",
                "redactSensitive": "tools"
              },

              // Tools configuration
              "tools": {
                "profile": "full",
                "web": {
                  "search": {
                    "enabled": false
                  },
                  "fetch": {
                    "enabled": true
                  }
                }
              }

              // Channel configuration can be added here:
              // "channels": {
              //   "telegram": {
              //     "botToken": "${TELEGRAM_BOT_TOKEN}",
              //     "enabled": true
              //   },
              //   "discord": {
              //     "token": "${DISCORD_BOT_TOKEN}"
              //   },
              //   "slack": {
              //     "botToken": "${SLACK_BOT_TOKEN}",
              //     "appToken": "${SLACK_APP_TOKEN}"
              //   }
              // }
            }
    controllers:
      main:
        initContainers:
          init-skills:
            command:
              - sh
              - -c
              - |
                cd /home/node/.openclaw/workspace && mkdir -p skills
                npx -y clawhub login --token "${CLAWHUB_TOKEN}" --no-browser
                npx -y clawhub whoami
                for skill in gog self-improving-agent github proactive-agent; do
                  attempt=1
                  max_attempts=5
                  while :; do
                    if npx -y clawhub install "$skill" --no-input --force; then
                      break
                    fi
                    if [ "$attempt" -ge "$max_attempts" ]; then
                      echo "ERROR: Failed to install skill after ${max_attempts} attempts: $skill"
                      exit 1
                    fi
                    backoff=$((attempt * 15))
                    echo "Install failed for $skill. Retrying in ${backoff}s (attempt ${attempt}/${max_attempts})..."
                    sleep "$backoff"
                    attempt=$((attempt + 1))
                  done
                done
